<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warhammer 40k Stream Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn { @apply w-12 h-12 flex items-center justify-center text-2xl font-bold rounded-lg transition-transform duration-100 active:scale-90; }
        .btn-green { @apply bg-emerald-500 text-white; }
        .btn-red { @apply bg-red-500 text-white; }
        .secondary-select { @apply w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600; }
        .tier-btn { @apply w-full text-left p-2 rounded-md bg-sky-600 hover:bg-sky-500 text-white transition-colors duration-150 active:scale-[0.98]; }
        .toggle-label { @apply block text-gray-400 text-sm; }
        .toggle-btn { @apply px-4 py-2 rounded-md font-semibold transition-colors; }
        .toggle-btn-active { @apply bg-sky-600 text-white ring-2 ring-sky-400; }
        .toggle-btn-inactive { @apply bg-gray-700 text-gray-300; }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #scoreSheetModal, #scoreSheetModal * {
                visibility: visible;
            }
            #scoreSheetModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 md:p-6">

    <!-- Page 1: Setup -->
    <div id="setupPage" class="max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-yellow-400">Game Setup</h1>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Player 1 Setup -->
            <div class="bg-gray-800 p-4 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-center">Player 1</h2>
                <input type="text" id="setup_p1_name" class="w-full bg-gray-700 text-white p-2 rounded-md text-xl text-center" placeholder="Player 1 Name">
                <input type="text" id="setup_p1_faction" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Faction">
                <input type="text" id="setup_p1_detachment" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Detachment">
                <div class="grid grid-cols-2 gap-2 text-center">
                    <div>
                        <span class="toggle-label">Role</span>
                        <div id="setup_p1_role" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="1" data-role="Attacker" class="w-1/2 toggle-btn toggle-btn-active">Attacker</button>
                            <button data-player="1" data-role="Defender" class="w-1/2 toggle-btn toggle-btn-inactive">Defender</button>
                        </div>
                    </div>
                    <div>
                        <span class="toggle-label">Missions</span>
                         <div id="setup_p1_missions" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="1" data-mission="Fixed" class="w-1/2 toggle-btn toggle-btn-active">Fixed</button>
                            <button data-player="1" data-mission="Tactical" class="w-1/2 toggle-btn toggle-btn-inactive">Tactical</button>
                        </div>
                    </div>
                </div>
                <div id="setup_p1_fixed_missions" class="space-y-2">
                    <select id="setup_p1_sec1" class="secondary-select"></select>
                    <select id="setup_p1_sec2" class="secondary-select"></select>
                </div>
            </div>
            <!-- Player 2 Setup -->
            <div class="bg-gray-800 p-4 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-center">Player 2</h2>
                <input type="text" id="setup_p2_name" class="w-full bg-gray-700 text-white p-2 rounded-md text-xl text-center" placeholder="Player 2 Name">
                <input type="text" id="setup_p2_faction" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Faction">
                <input type="text" id="setup_p2_detachment" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Detachment">
                 <div class="grid grid-cols-2 gap-2 text-center">
                    <div>
                        <span class="toggle-label">Role</span>
                        <div id="setup_p2_role" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="2" data-role="Attacker" class="w-1/2 toggle-btn toggle-btn-inactive">Attacker</button>
                            <button data-player="2" data-role="Defender" class="w-1/2 toggle-btn toggle-btn-active">Defender</button>
                        </div>
                    </div>
                    <div>
                        <span class="toggle-label">Missions</span>
                         <div id="setup_p2_missions" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="2" data-mission="Fixed" class="w-1/2 toggle-btn toggle-btn-active">Fixed</button>
                            <button data-player="2" data-mission="Tactical" class="w-1/2 toggle-btn toggle-btn-inactive">Tactical</button>
                        </div>
                    </div>
                </div>
                <div id="setup_p2_fixed_missions" class="space-y-2">
                    <select id="setup_p2_sec1" class="secondary-select"></select>
                    <select id="setup_p2_sec2" class="secondary-select"></select>
                </div>
            </div>
        </div>
        <div class="text-center mt-8">
            <button id="startGameBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg text-xl">Start Game</button>
        </div>
    </div>

    <!-- Page 2: Scoreboard -->
    <div id="scoreboardPage" class="max-w-4xl mx-auto hidden">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-yellow-400">40k Stream Controller</h1>
        </header>
        <div class="bg-gray-800 p-4 rounded-lg mb-6 flex flex-col items-center">
            <h2 class="text-2xl font-semibold mb-4">Game State</h2>
            <div class="flex items-center space-x-4">
                <button id="prevTurnBtn" class="btn btn-red">-</button>
                <div class="text-center">
                    <div class="text-lg text-gray-400">Turn</div>
                    <div id="turn" class="text-5xl font-bold">1</div>
                </div>
                <button id="nextTurnBtn" class="btn btn-green">+</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Player 1 Scoreboard -->
            <div id="player1" class="bg-gray-800 p-4 rounded-lg space-y-4">
                <div id="p1_name" class="text-2xl font-bold text-center"></div>
                <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">Primary VP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="1" data-field="primaryVp" class="btn btn-red op-btn">-</button>
                        <span id="p1_primaryVp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="1" data-field="primaryVp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">CP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="1" data-field="cp" class="btn btn-red op-btn">-</button>
                        <span id="p1_cp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="1" data-field="cp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                 <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">Challenger VP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="1" data-field="challengerVp" class="btn btn-red op-btn">-</button>
                        <span id="p1_challengerVp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="1" data-field="challengerVp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                <div id="p1_secondaries_area" class="space-y-3"></div>
                <div class="text-center bg-gray-900 p-3 rounded-lg">
                    <div class="text-lg text-gray-400">Total Score</div>
                    <div id="p1_totalVp" class="text-5xl font-bold text-yellow-400">0</div>
                </div>
            </div>
            <!-- Player 2 Scoreboard -->
            <div id="player2" class="bg-gray-800 p-4 rounded-lg space-y-4">
                <div id="p2_name" class="text-2xl font-bold text-center"></div>
                 <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">Primary VP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="2" data-field="primaryVp" class="btn btn-red op-btn">-</button>
                        <span id="p2_primaryVp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="2" data-field="primaryVp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">CP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="2" data-field="cp" class="btn btn-red op-btn">-</button>
                        <span id="p2_cp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="2" data-field="cp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">Challenger VP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="2" data-field="challengerVp" class="btn btn-red op-btn">-</button>
                        <span id="p2_challengerVp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="2" data-field="challengerVp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                <div id="p2_secondaries_area" class="space-y-3"></div>
                <div class="text-center bg-gray-900 p-3 rounded-lg">
                    <div class="text-lg text-gray-400">Total Score</div>
                    <div id="p2_totalVp" class="text-5xl font-bold text-yellow-400">0</div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-8 space-y-4">
            <button id="fullScoreSheetBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg">Full Score Sheet</button>
            <button id="backToSetupBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Return to Setup</button>
            <button id="resetGameBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Reset Game</button>
        </footer>
    </div>

    <!-- Score Sheet Modal -->
    <div id="scoreSheetModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-gray-800 text-white p-6 rounded-lg max-w-4xl w-full">
            <h2 class="text-2xl font-bold mb-4 text-center">Full Score Sheet</h2>
            <div id="scoreSheetContent" class="overflow-x-auto"></div>
            <div class="text-center mt-6 no-print">
                <button id="printScoreSheetBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded">Print to PDF</button>
                <button id="closeScoreSheetBtn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAlhqPMvqP1MO_sV_jIXf7jrrm1MJtL2aI",
          authDomain: "wtwg-streaming.firebaseapp.com",
          projectId: "wtwg-streaming",
          storageBucket: "wtwg-streaming.appspot.com",
          messagingSenderId: "889956031791",
          appId: "1:889956031791:web:d9292c951c8270f6abd5da",
          measurementId: "G-5T9HMW7DMX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let gameState = {};
        let appDocRef;
        let fixedObjectives = [];
        let tacticalObjectives = [];

        const setupPage = document.getElementById('setupPage');
        const scoreboardPage = document.getElementById('scoreboardPage');
        const startGameBtn = document.getElementById('startGameBtn');
        const backToSetupBtn = document.getElementById('backToSetupBtn');
        const fullScoreSheetBtn = document.getElementById('fullScoreSheetBtn');
        const scoreSheetModal = document.getElementById('scoreSheetModal');
        const closeScoreSheetBtn = document.getElementById('closeScoreSheetBtn');
        const printScoreSheetBtn = document.getElementById('printScoreSheetBtn');

        function showScoreboard() {
            setupPage.classList.add('hidden');
            scoreboardPage.classList.remove('hidden');
        }

        function showSetup() {
            scoreboardPage.classList.add('hidden');
            setupPage.classList.remove('hidden');
        }

        function updateUI(data) {
            if (!data || !data.gameState) return;
            gameState = data.gameState;
            
            let fixedData = data.fixed_objectives || [];
            if (typeof fixedData === 'string') {
                try { fixedObjectives = JSON.parse(fixedData); } catch (e) { console.error("Failed to parse fixed_objectives:", e); fixedObjectives = []; }
            } else { fixedObjectives = fixedData; }

            let tacticalData = data.tactical_objectives || [];
            if (typeof tacticalData === 'string') {
                try { tacticalObjectives = JSON.parse(tacticalData); } catch (e) { console.error("Failed to parse tactical_objectives:", e); tacticalObjectives = []; }
            } else { tacticalObjectives = tacticalData; }
            
            if (!gameState.setupComplete) {
                showSetup();
                populateSetupDropdowns(fixedObjectives);
                return;
            }
            showScoreboard();
            
            document.getElementById('turn').textContent = gameState.turn;
            document.getElementById('p1_name').textContent = gameState.player1.name;
            document.getElementById('p1_cp').textContent = gameState.player1.cp;
            document.getElementById('p1_primaryVp').textContent = gameState.player1.primaryVp;
            document.getElementById('p1_challengerVp').textContent = gameState.player1.challengerVp;
            document.getElementById('p1_totalVp').textContent = gameState.player1.totalVp;

            document.getElementById('p2_name').textContent = gameState.player2.name;
            document.getElementById('p2_cp').textContent = gameState.player2.cp;
            document.getElementById('p2_primaryVp').textContent = gameState.player2.primaryVp;
            document.getElementById('p2_challengerVp').textContent = gameState.player2.challengerVp;
            document.getElementById('p2_totalVp').textContent = gameState.player2.totalVp;

            renderPlayerSecondaries(1);
            renderPlayerSecondaries(2);
        }

        function populateSetupDropdowns(objectives) {
            const selects = document.querySelectorAll('#setupPage .secondary-select');
            selects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = "Select Secondary...";
                defaultOption.textContent = "Select Secondary...";
                select.appendChild(defaultOption);
                objectives.forEach(obj => {
                    const option = document.createElement('option');
                    option.value = obj.name;
                    option.textContent = obj.name;
                    select.appendChild(option);
                });
                select.value = currentVal;
            });
        }

        function renderPlayerSecondaries(playerNum) {
            const player = gameState[`player${playerNum}`];
            const area = document.getElementById(`p${playerNum}_secondaries_area`);
            area.innerHTML = '';

            if (player.missionType === 'Fixed') {
                for (let i = 1; i <= 2; i++) {
                    const secondaryKey = `secondary${i}`;
                    const secondary = player[secondaryKey] || { name: 'Not Selected', score: 0 };
                    const container = document.createElement('div');
                    container.className = 'bg-gray-900 p-3 rounded-lg';
                    container.innerHTML = `
                        <h3 class="text-lg font-bold mb-2">${secondary.name}</h3>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xl font-semibold">Score: <span id="p${playerNum}_sec${i}_score" class="font-bold">${secondary.score}</span></span>
                            <div>
                                <button data-player="${playerNum}" data-secondary="${i}" class="btn btn-red op-sec-btn">-</button>
                                <button data-player="${playerNum}" data-secondary="${i}" class="btn btn-green op-sec-btn">+</button>
                            </div>
                        </div>
                    `;
                    area.appendChild(container);
                }
            } else {
                const container = document.createElement('div');
                container.className = 'bg-gray-900 p-3 rounded-lg';
                container.innerHTML = `
                    <h3 class="text-xl font-bold text-center mb-2">Tactical Missions</h3>
                    <div id="p${playerNum}_active_mission" class="bg-gray-800 p-3 rounded-md min-h-[100px] mb-3"></div>
                    <button data-player="${playerNum}" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded draw-tactical-btn">Draw Tactical Mission</button>
                `;
                area.appendChild(container);
            }
        }
        
        async function handleStartGame() {
            const p1_name = document.getElementById('setup_p1_name').value || "Player 1";
            const p1_faction = document.getElementById('setup_p1_faction').value;
            const p1_detachment = document.getElementById('setup_p1_detachment').value;
            const p1_role = document.querySelector('#setup_p1_role .toggle-btn-active').dataset.role;
            const p1_missions = document.querySelector('#setup_p1_missions .toggle-btn-active').dataset.mission;

            const p2_name = document.getElementById('setup_p2_name').value || "Player 2";
            const p2_faction = document.getElementById('setup_p2_faction').value;
            const p2_detachment = document.getElementById('setup_p2_detachment').value;
            const p2_role = document.querySelector('#setup_p2_role .toggle-btn-active').dataset.role;
            const p2_missions = document.querySelector('#setup_p2_missions .toggle-btn-active').dataset.mission;

            const payload = {
                'gameState.player1.name': p1_name, 'gameState.player1.faction': p1_faction, 'gameState.player1.detachment': p1_detachment, 'gameState.player1.role': p1_role, 'gameState.player1.missionType': p1_missions,
                'gameState.player2.name': p2_name, 'gameState.player2.faction': p2_faction, 'gameState.player2.detachment': p2_detachment, 'gameState.player2.role': p2_role, 'gameState.player2.missionType': p2_missions,
                'gameState.setupComplete': true
            };

            if (p1_missions === 'Fixed') {
                payload['gameState.player1.secondary1.name'] = document.getElementById('setup_p1_sec1').value;
                payload['gameState.player1.secondary2.name'] = document.getElementById('setup_p1_sec2').value;
            }
             if (p2_missions === 'Fixed') {
                payload['gameState.player2.secondary1.name'] = document.getElementById('setup_p2_sec1').value;
                payload['gameState.player2.secondary2.name'] = document.getElementById('setup_p2_sec2').value;
            }

            await updateDoc(appDocRef, payload);
        }

        async function handleBackToSetup() {
            await updateDoc(appDocRef, { 'gameState.setupComplete': false });
        }

        function toggleFixedMissionView(playerNum, missionType) {
            const fixedMissionsDiv = document.getElementById(`setup_p${playerNum}_fixed_missions`);
            if (missionType === 'Fixed') {
                fixedMissionsDiv.classList.remove('hidden');
            } else {
                fixedMissionsDiv.classList.add('hidden');
            }
        }

        function renderScoreSheet() {
            const content = document.getElementById('scoreSheetContent');
            content.innerHTML = `<p class="text-center">Score sheet coming soon!</p>`;
        }

        function calculateTotals() {
            const p1 = gameState.player1;
            const p2 = gameState.player2;
            p1.totalVp = p1.primaryVp + p1.challengerVp + (p1.secondary1?.score || 0) + (p1.secondary2?.score || 0);
            p2.totalVp = p2.primaryVp + p2.challengerVp + (p2.secondary1?.score || 0) + (p2.secondary2?.score || 0);
        }

        async function updateFirestore(payload) {
            calculateTotals();
            const fullPayload = { ...payload };
            fullPayload['gameState.player1.totalVp'] = gameState.player1.totalVp;
            fullPayload['gameState.player2.totalVp'] = gameState.player2.totalVp;
            await updateDoc(appDocRef, fullPayload);
        }

        async function handleScoreboardClick(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const player = target.dataset.player;
            const field = target.dataset.field;
            const secondary = target.dataset.secondary;

            if (field) { // Primary, CP, Challenger
                const isIncrement = target.classList.contains('btn-green');
                const key = `gameState.player${player}.${field}`;
                const currentValue = gameState[`player${player}`][field];
                const newValue = isIncrement ? currentValue + 1 : Math.max(0, currentValue - 1);
                await updateFirestore({ [key]: newValue });
            } else if (secondary) { // Fixed Secondary
                const isIncrement = target.classList.contains('btn-green');
                const key = `gameState.player${player}.secondary${secondary}.score`;
                const currentScore = gameState[`player${player}`][`secondary${secondary}`].score;
                const newValue = isIncrement ? currentScore + 1 : Math.max(0, currentScore - 1);
                await updateFirestore({ [key]: newValue });
            }
        }

        async function init() {
            try {
                await signInAnonymously(auth);
                const docId = "warhammer-game-data";
                appDocRef = doc(db, "gamedata", docId);

                const appDocSnap = await getDoc(appDocRef);
                if (!appDocSnap.exists()) {
                    const initialData = {
                        gameState: {
                            setupComplete: false, turn: 1,
                            player1: { name: "Player 1", faction: "", detachment: "", role: "Attacker", missionType: "Fixed", cp: 0, primaryVp: 0, challengerVp: 0, totalVp: 0, drawnTacticalIds: [], activeTactical: null, secondary1: {name: "Select Secondary...", score: 0}, secondary2: {name: "Select Secondary...", score: 0} },
                            player2: { name: "Player 2", faction: "", detachment: "", role: "Defender", missionType: "Fixed", cp: 0, primaryVp: 0, challengerVp: 0, totalVp: 0, drawnTacticalIds: [], activeTactical: null, secondary1: {name: "Select Secondary...", score: 0}, secondary2: {name: "Select Secondary...", score: 0} }
                        },
                        fixed_objectives: [ { name: "Example Fixed", description: "Score points.", scoring_tiers: [{ label: "+5 VP", vp: 5 }] } ],
                        tactical_objectives: [ { id: 1, name: "Example Tactical", description: "Score points.", scoring_tiers: [{ label: "+3 VP", vp: 3 }] } ]
                    };
                    await setDoc(appDocRef, initialData);
                }

                onSnapshot(appDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        updateUI(docSnap.data());
                    }
                });

                startGameBtn.addEventListener('click', handleStartGame);
                backToSetupBtn.addEventListener('click', handleBackToSetup);
                fullScoreSheetBtn.addEventListener('click', () => {
                    renderScoreSheet();
                    scoreSheetModal.classList.remove('hidden');
                });
                closeScoreSheetBtn.addEventListener('click', () => scoreSheetModal.classList.add('hidden'));
                printScoreSheetBtn.addEventListener('click', () => window.print());
                
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (btn.classList.contains('toggle-btn-active')) return;
                        const parent = btn.parentElement;
                        parent.querySelectorAll('.toggle-btn').forEach(b => b.classList.replace('toggle-btn-active', 'toggle-btn-inactive'));
                        btn.classList.replace('toggle-btn-inactive', 'toggle-btn-active');

                        if (parent.id.includes('role')) {
                           const otherPlayer = btn.dataset.player === '1' ? '2' : '1';
                           const otherRole = btn.dataset.role === 'Attacker' ? 'Defender' : 'Attacker';
                           const otherParent = document.getElementById(`setup_p${otherPlayer}_role`);
                           otherParent.querySelectorAll('.toggle-btn').forEach(b => {
                               if (b.dataset.role === otherRole) b.classList.replace('toggle-btn-inactive', 'toggle-btn-active');
                               else b.classList.replace('toggle-btn-active', 'toggle-btn-inactive');
                           });
                        }
                        
                        if (parent.id.includes('missions')) {
                            toggleFixedMissionView(btn.dataset.player, btn.dataset.mission);
                        }
                    });
                });

                scoreboardPage.addEventListener('click', handleScoreboardClick);

            } catch (error) {
                console.error("A critical error occurred during initialization:", error);
            }
        }

        init();
    </script>
</body>
</html>
