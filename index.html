<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warhammer 40k Stream Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn { @apply w-12 h-12 flex items-center justify-center text-2xl font-bold rounded-lg transition-transform duration-100 active:scale-90; }
        .btn-green { @apply bg-emerald-500 text-white; }
        .btn-red { @apply bg-red-500 text-white; }
        .secondary-select { @apply w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600; }
        .tier-btn { @apply w-full text-left p-2 rounded-md bg-sky-600 hover:bg-sky-500 text-white transition-colors duration-150 active:scale-[0.98]; }
        .toggle-label { @apply block text-gray-400 text-sm; }
        .toggle-btn { @apply px-4 py-2 rounded-md font-semibold; }
        .toggle-btn-active { @apply bg-sky-600 text-white; }
        .toggle-btn-inactive { @apply bg-gray-700 text-gray-300; }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 md:p-6">

    <!-- Page 1: Setup -->
    <div id="setupPage" class="max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-yellow-400">Game Setup</h1>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Player 1 Setup -->
            <div class="bg-gray-800 p-4 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-center">Player 1</h2>
                <input type="text" id="setup_p1_name" class="w-full bg-gray-700 text-white p-2 rounded-md text-xl text-center" placeholder="Player 1 Name">
                <input type="text" id="setup_p1_faction" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Faction">
                <input type="text" id="setup_p1_detachment" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Detachment">
                <div class="grid grid-cols-2 gap-2 text-center">
                    <div>
                        <span class="toggle-label">Role</span>
                        <div id="setup_p1_role" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="1" data-role="Attacker" class="w-1/2 toggle-btn toggle-btn-active">Attacker</button>
                            <button data-player="1" data-role="Defender" class="w-1/2 toggle-btn toggle-btn-inactive">Defender</button>
                        </div>
                    </div>
                    <div>
                        <span class="toggle-label">Missions</span>
                         <div id="setup_p1_missions" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="1" data-mission="Fixed" class="w-1/2 toggle-btn toggle-btn-active">Fixed</button>
                            <button data-player="1" data-mission="Tactical" class="w-1/2 toggle-btn toggle-btn-inactive">Tactical</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Player 2 Setup -->
            <div class="bg-gray-800 p-4 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-center">Player 2</h2>
                <input type="text" id="setup_p2_name" class="w-full bg-gray-700 text-white p-2 rounded-md text-xl text-center" placeholder="Player 2 Name">
                <input type="text" id="setup_p2_faction" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Faction">
                <input type="text" id="setup_p2_detachment" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Detachment">
                 <div class="grid grid-cols-2 gap-2 text-center">
                    <div>
                        <span class="toggle-label">Role</span>
                        <div id="setup_p2_role" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="2" data-role="Attacker" class="w-1/2 toggle-btn toggle-btn-inactive">Attacker</button>
                            <button data-player="2" data-role="Defender" class="w-1/2 toggle-btn toggle-btn-active">Defender</button>
                        </div>
                    </div>
                    <div>
                        <span class="toggle-label">Missions</span>
                         <div id="setup_p2_missions" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="2" data-mission="Fixed" class="w-1/2 toggle-btn toggle-btn-active">Fixed</button>
                            <button data-player="2" data-mission="Tactical" class="w-1/2 toggle-btn toggle-btn-inactive">Tactical</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-8">
            <button id="startGameBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg text-xl">Start Game</button>
        </div>
    </div>

    <!-- Page 2: Scoreboard -->
    <div id="scoreboardPage" class="max-w-4xl mx-auto hidden">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-yellow-400">40k Stream Controller</h1>
        </header>
        <!-- Game State Controls -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 flex flex-col items-center">
            <h2 class="text-2xl font-semibold mb-4">Game State</h2>
            <div class="flex items-center space-x-4">
                <button id="prevTurnBtn" class="btn btn-red">-</button>
                <div class="text-center">
                    <div class="text-lg text-gray-400">Turn</div>
                    <div id="turn" class="text-5xl font-bold">1</div>
                </div>
                <button id="nextTurnBtn" class="btn btn-green">+</button>
            </div>
        </div>
        <!-- Player Scoreboard Panels -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Player 1 Scoreboard -->
            <div id="player1" class="bg-gray-800 p-4 rounded-lg space-y-4">
                <div id="p1_name" class="text-2xl font-bold text-center"></div>
                <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">Primary VP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="1" data-field="primaryVp" class="btn btn-red op-btn">-</button>
                        <span id="p1_primaryVp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="1" data-field="primaryVp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">CP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="1" data-field="cp" class="btn btn-red op-btn">-</button>
                        <span id="p1_cp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="1" data-field="cp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                <!-- Player 1 Secondary Area -->
                <div id="p1_secondaries_area" class="space-y-3"></div>
                <div class="text-center bg-gray-900 p-3 rounded-lg">
                    <div class="text-lg text-gray-400">Total Score</div>
                    <div id="p1_totalVp" class="text-5xl font-bold text-yellow-400">0</div>
                </div>
            </div>
            <!-- Player 2 Scoreboard -->
            <div id="player2" class="bg-gray-800 p-4 rounded-lg space-y-4">
                <div id="p2_name" class="text-2xl font-bold text-center"></div>
                 <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">Primary VP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="2" data-field="primaryVp" class="btn btn-red op-btn">-</button>
                        <span id="p2_primaryVp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="2" data-field="primaryVp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">CP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="2" data-field="cp" class="btn btn-red op-btn">-</button>
                        <span id="p2_cp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="2" data-field="cp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                <!-- Player 2 Secondary Area -->
                <div id="p2_secondaries_area" class="space-y-3"></div>
                <div class="text-center bg-gray-900 p-3 rounded-lg">
                    <div class="text-lg text-gray-400">Total Score</div>
                    <div id="p2_totalVp" class="text-5xl font-bold text-yellow-400">0</div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-8 space-y-4">
            <button id="resetGameBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Reset Game</button>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAlhqPMvqP1MO_sV_jIXf7jrrm1MJtL2aI",
  authDomain: "wtwg-streaming.firebaseapp.com",
  projectId: "wtwg-streaming",
  storageBucket: "wtwg-streaming.firebasestorage.app",
  messagingSenderId: "889956031791",
  appId: "1:889956031791:web:d9292c951c8270f6abd5da",
  measurementId: "G-5T9HMW7DMX"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let gameState = {};
        let appDocRef;
        let fixedObjectives = [];
        let tacticalObjectives = [];

        // --- Page Elements ---
        const setupPage = document.getElementById('setupPage');
        const scoreboardPage = document.getElementById('scoreboardPage');
        const startGameBtn = document.getElementById('startGameBtn');

        // --- Logic for Page Switching ---
        function showScoreboard() {
            setupPage.classList.add('hidden');
            scoreboardPage.classList.remove('hidden');
        }

        function showSetup() {
            scoreboardPage.classList.add('hidden');
            setupPage.classList.remove('hidden');
        }

        // --- UI Update Logic ---
        function updateUI(data) {
            if (!data || !data.gameState) return;
            gameState = data.gameState;
            fixedObjectives = data.fixed_objectives || [];
            tacticalObjectives = data.tactical_objectives || [];
            
            if (!gameState.setupComplete) {
                showSetup();
                return;
            }
            showScoreboard();

            // Populate scoreboard
            document.getElementById('turn').textContent = gameState.turn;
            // ... (rest of the scoreboard UI update logic will go here)
        }
        
        async function handleStartGame() {
            const p1_name = document.getElementById('setup_p1_name').value || "Player 1";
            const p1_faction = document.getElementById('setup_p1_faction').value;
            const p1_detachment = document.getElementById('setup_p1_detachment').value;
            const p1_role = document.querySelector('#setup_p1_role .toggle-btn-active').dataset.role;
            const p1_missions = document.querySelector('#setup_p1_missions .toggle-btn-active').dataset.mission;

            const p2_name = document.getElementById('setup_p2_name').value || "Player 2";
            const p2_faction = document.getElementById('setup_p2_faction').value;
            const p2_detachment = document.getElementById('setup_p2_detachment').value;
            const p2_role = document.querySelector('#setup_p2_role .toggle-btn-active').dataset.role;
            const p2_missions = document.querySelector('#setup_p2_missions .toggle-btn-active').dataset.mission;

            const payload = {
                'gameState.player1.name': p1_name,
                'gameState.player1.faction': p1_faction,
                'gameState.player1.detachment': p1_detachment,
                'gameState.player1.role': p1_role,
                'gameState.player1.missionType': p1_missions,
                'gameState.player2.name': p2_name,
                'gameState.player2.faction': p2_faction,
                'gameState.player2.detachment': p2_detachment,
                'gameState.player2.role': p2_role,
                'gameState.player2.missionType': p2_missions,
                'gameState.setupComplete': true
            };
            await updateDoc(appDocRef, payload);
        }

        // --- Main Init Function ---
        async function init() {
            try {
                await signInAnonymously(auth);
                const docId = "warhammer-game-data";
                appDocRef = doc(db, "gamedata", docId);

                const appDocSnap = await getDoc(appDocRef);
                if (!appDocSnap.exists()) {
                    // Create the document with a full default structure
                    const initialData = {
                        gameState: {
                            setupComplete: false,
                            turn: 1,
                            player1: { name: "Player 1", faction: "", detachment: "", role: "Attacker", missionType: "Fixed", cp: 0, primaryVp: 0, totalVp: 0, drawnTacticalIds: [], activeTactical: null },
                            player2: { name: "Player 2", faction: "", detachment: "", role: "Defender", missionType: "Fixed", cp: 0, primaryVp: 0, totalVp: 0, drawnTacticalIds: [], activeTactical: null }
                        },
                        fixed_objectives: [ { name: "Example Fixed", description: "Score points.", scoring_tiers: [{ label: "+5 VP", vp: 5 }] } ],
                        tactical_objectives: [ { id: 1, name: "Example Tactical", description: "Score points.", scoring_tiers: [{ label: "+3 VP", vp: 3 }] } ]
                    };
                    await setDoc(appDocRef, initialData);
                }

                onSnapshot(appDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        updateUI(docSnap.data());
                    }
                });

                // --- Event Listeners ---
                startGameBtn.addEventListener('click', handleStartGame);
                
                // Toggle button logic
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const parent = btn.parentElement;
                        parent.querySelectorAll('.toggle-btn').forEach(b => {
                            b.classList.remove('toggle-btn-active');
                            b.classList.add('toggle-btn-inactive');
                        });
                        btn.classList.add('toggle-btn-active');
                        btn.classList.remove('toggle-btn-inactive');

                        // Auto-swap attacker/defender
                        if (parent.id.includes('role')) {
                           const otherPlayer = btn.dataset.player === '1' ? '2' : '1';
                           const otherRole = btn.dataset.role === 'Attacker' ? 'Defender' : 'Attacker';
                           const otherParent = document.getElementById(`setup_p${otherPlayer}_role`);
                           otherParent.querySelectorAll('.toggle-btn').forEach(b => {
                               if (b.dataset.role === otherRole) {
                                   b.classList.add('toggle-btn-active');
                                   b.classList.remove('toggle-btn-inactive');
                               } else {
                                   b.classList.remove('toggle-btn-active');
                                   b.classList.add('toggle-btn-inactive');
                               }
                           });
                        }
                    });
                });

            } catch (error) {
                console.error("A critical error occurred during initialization:", error);
            }
        }

        init();
    </script>
</body>
</html>
