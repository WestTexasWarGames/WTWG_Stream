<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warhammer 40k Stream Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn { @apply w-12 h-12 flex items-center justify-center text-2xl font-bold rounded-lg transition-transform duration-100 active:scale-90; }
        .btn-green { @apply bg-emerald-500 text-white; }
        .btn-red { @apply bg-red-500 text-white; }
        .secondary-select { @apply w-full bg-gray-800 text-white p-2 rounded-md border border-gray-700; }
        .tier-btn { @apply w-full text-left p-2 rounded-md bg-sky-600 hover:bg-sky-500 text-white transition-colors duration-150 active:scale-[0.98] border border-sky-400 shadow-md; }
        .toggle-label { @apply block text-gray-400 text-sm; }
        .toggle-btn { @apply px-4 py-2 rounded-md font-semibold transition-colors; }
        .toggle-btn-active { @apply bg-sky-600 text-white ring-2 ring-sky-400; }
        .toggle-btn-inactive { @apply bg-gray-700 text-gray-300; }
        
        @media print {
            body * {
                visibility: hidden;A
            }
            #scoreSheetModal, #scoreSheetModal * {
                visibility: visible;
            }A
            #scoreSheetModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
            }
            .no-print {
                display: none;
            }
            #scoreSheetContent {
                color: black;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 md:p-6">

    <!-- Page 1: Setup -->
    <div id="setupPage" class="max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-yellow-400">Game Setup</h1>
        </header>
        <div class="bg-gray-800 p-4 rounded-lg space-y-4 mb-6">
             <h2 class="text-2xl font-bold text-center">Mission Setup</h2>
             <select id="setup_primary_mission" class="secondary-select"></select>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Player 1 Setup -->
            <div class="bg-gray-800 p-4 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-center">Player 1</h2>
                <input type="text" id="setup_p1_name" class="w-full bg-gray-700 text-white p-2 rounded-md text-xl text-center" placeholder="Player 1 Name">
                <input type="text" id="setup_p1_faction" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Faction">
                <input type="text" id="setup_p1_detachment" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Detachment">
                <div class="grid grid-cols-2 gap-2 text-center">
                    <div>
                        <span class="toggle-label">Role</span>
                        <div id="setup_p1_role" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="1" data-role="Attacker" class="w-1/2 toggle-btn toggle-btn-active">Attacker</button>
                            <button data-player="1" data-role="Defender" class="w-1/2 toggle-btn toggle-btn-inactive">Defender</button>
                        </div>
                    </div>
                    <div>
                        <span class="toggle-label">Missions</span>
                         <div id="setup_p1_missions" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="1" data-mission="Fixed" class="w-1/2 toggle-btn toggle-btn-active">Fixed</button>
                            <button data-player="1" data-mission="Tactical" class="w-1/2 toggle-btn toggle-btn-inactive">Tactical</button>
                        </div>
                    </div>
                </div>
                <div id="setup_p1_fixed_missions" class="space-y-2">
                    <select id="setup_p1_sec1" class="secondary-select"></select>
                    <select id="setup_p1_sec2" class="secondary-select"></select>
                </div>
            </div>
            <!-- Player 2 Setup -->
            <div class="bg-gray-800 p-4 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-center">Player 2</h2>
                <input type="text" id="setup_p2_name" class="w-full bg-gray-700 text-white p-2 rounded-md text-xl text-center" placeholder="Player 2 Name">
                <input type="text" id="setup_p2_faction" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Faction">
                <input type="text" id="setup_p2_detachment" class="w-full bg-gray-700 text-white p-2 rounded-md text-center" placeholder="Detachment">
                 <div class="grid grid-cols-2 gap-2 text-center">
                    <div>
                        <span class="toggle-label">Role</span>
                        <div id="setup_p2_role" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="2" data-role="Attacker" class="w-1/2 toggle-btn toggle-btn-inactive">Attacker</button>
                            <button data-player="2" data-role="Defender" class="w-1/2 toggle-btn toggle-btn-active">Defender</button>
                        </div>
                    </div>
                    <div>
                        <span class="toggle-label">Missions</span>
                         <div id="setup_p2_missions" class="flex rounded-md bg-gray-700 p-1">
                            <button data-player="2" data-mission="Fixed" class="w-1/2 toggle-btn toggle-btn-active">Fixed</button>
                            <button data-player="2" data-mission="Tactical" class="w-1/2 toggle-btn toggle-btn-inactive">Tactical</button>
                        </div>
                    </div>
                </div>
                <div id="setup_p2_fixed_missions" class="space-y-2">
                    <select id="setup_p2_sec1" class="secondary-select"></select>
                    <select id="setup_p2_sec2" class="secondary-select"></select>
                </div>
            </div>
        </div>
        <div class="text-center mt-8">
            <button id="startGameBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg text-xl">Start Game</button>
        </div>
    </div>

    <!-- Page 2: Scoreboard -->
    <div id="scoreboardPage" class="max-w-4xl mx-auto hidden">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-yellow-400">40k Stream Controller</h1>
        </header>
        <div class="bg-gray-800 p-4 rounded-lg mb-6 flex flex-col items-center">
            <h2 class="text-2xl font-semibold mb-4">Game State</h2>
            <div class="flex items-center space-x-4">
                <button id="prevTurnBtn" class="btn btn-red">-</button>
                <div class="text-center">
                    <div class="text-lg text-gray-400">Turn</div>
                    <div id="turn" class="text-5xl font-bold">1</div>
                </div>
                <button id="nextTurnBtn" class="btn btn-green">+</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Player 1 Scoreboard -->
            <div id="player1" class="bg-gray-800 p-4 rounded-lg space-y-4">
                <div id="p1_name" class="text-2xl font-bold text-center"></div>
                <div id="p1_primary_area" class="bg-gray-900 p-3 rounded-lg"></div>
                <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">CP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="1" data-field="cp" class="btn btn-red op-btn">-</button>
                        <span id="p1_cp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="1" data-field="cp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                 <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">Challenger VP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="1" data-field="challengerVp" class="btn btn-red op-btn">-</button>
                        <span id="p1_challengerVp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="1" data-field="challengerVp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                 <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">Tactical VP</span>
                    <div class="flex items-center space-x-3">
                        <span id="p1_tacticalVp" class="text-3xl font-bold w-12 text-center">0</span>
                    </div>
                </div>
                <div id="p1_secondaries_area" class="space-y-3"></div>
                <div class="text-center bg-gray-900 p-3 rounded-lg">
                    <div class="text-lg text-gray-400">Total Score</div>
                    <div id="p1_totalVp" class="text-5xl font-bold text-yellow-400">0</div>
                </div>
            </div>
            <!-- Player 2 Scoreboard -->
            <div id="player2" class="bg-gray-800 p-4 rounded-lg space-y-4">
                <div id="p2_name" class="text-2xl font-bold text-center"></div>
                 <div id="p2_primary_area" class="bg-gray-900 p-3 rounded-lg"></div>
                <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">CP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="2" data-field="cp" class="btn btn-red op-btn">-</button>
                        <span id="p2_cp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="2" data-field="cp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">Challenger VP</span>
                    <div class="flex items-center space-x-3">
                        <button data-player="2" data-field="challengerVp" class="btn btn-red op-btn">-</button>
                        <span id="p2_challengerVp" class="text-3xl font-bold w-12 text-center">0</span>
                        <button data-player="2" data-field="challengerVp" class="btn btn-green op-btn">+</button>
                    </div>
                </div>
                 <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg">
                    <span class="text-xl font-semibold">Tactical VP</span>
                    <div class="flex items-center space-x-3">
                        <span id="p2_tacticalVp" class="text-3xl font-bold w-12 text-center">0</span>
                    </div>
                </div>
                <div id="p2_secondaries_area" class="space-y-3"></div>
                <div class="text-center bg-gray-900 p-3 rounded-lg">
                    <div class="text-lg text-gray-400">Total Score</div>
                    <div id="p2_totalVp" class="text-5xl font-bold text-yellow-400">0</div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-8 space-y-4">
            <button id="fullScoreSheetBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg">Full Score Sheet</button>
            <button id="backToSetupBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Return to Setup</button>
            <button id="resetGameBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Reset Game</button>
        </footer>
    </div>

    <!-- Score Sheet Modal -->
    <div id="scoreSheetModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-gray-800 text-white p-6 rounded-lg max-w-4xl w-full">
            <h2 class="text-2xl font-bold mb-4 text-center">Full Score Sheet</h2>
            <div id="scoreSheetContent" class="overflow-x-auto"></div>
            <div class="text-center mt-6 no-print">
                <button id="printScoreSheetBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded">Print to PDF</button>
                <button id="closeScoreSheetBtn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAlhqPMvqP1MO_sV_jIXf7jrrm1MJtL2aI",
          authDomain: "wtwg-streaming.firebaseapp.com",
          projectId: "wtwg-streaming",
          storageBucket: "wtwg-streaming.appspot.com",
          messagingSenderId: "889956031791",
          appId: "1:889956031791:web:d9292c951c8270f6abd5da",
          measurementId: "G-5T9HMW7DMX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let gameState = {};
        let appDocRef;
        let primaryMissions = [];
        let fixedObjectives = [];
        let tacticalObjectives = [];

        const setupPage = document.getElementById('setupPage');
        const scoreboardPage = document.getElementById('scoreboardPage');
        const startGameBtn = document.getElementById('startGameBtn');
        const backToSetupBtn = document.getElementById('backToSetupBtn');
        const fullScoreSheetBtn = document.getElementById('fullScoreSheetBtn');
        const scoreSheetModal = document.getElementById('scoreSheetModal');
        const closeScoreSheetBtn = document.getElementById('closeScoreSheetBtn');
        const printScoreSheetBtn = document.getElementById('printScoreSheetBtn');

        function showScoreboard() {
            setupPage.classList.add('hidden');
            scoreboardPage.classList.remove('hidden');
        }

        function showSetup() {
            scoreboardPage.classList.add('hidden');
            setupPage.classList.remove('hidden');
        }

        function updateUI(data) {
            if (!data || !data.gameState) return;
            gameState = data.gameState;
            
            primaryMissions = data.primary_missions || [];
            fixedObjectives = data.fixed_objectives || [];
            tacticalObjectives = data.tactical_objectives || [];
            
            if (!gameState.setupComplete) {
                showSetup();
                populateSetupDropdowns(fixedObjectives, primaryMissions);
                return;
            }
            showScoreboard();
            
            document.getElementById('turn').textContent = gameState.turn;
            document.getElementById('p1_name').textContent = gameState.player1.name;
            document.getElementById('p1_cp').textContent = gameState.player1.cp;
            document.getElementById('p1_challengerVp').textContent = gameState.player1.challengerVp;
            document.getElementById('p1_tacticalVp').textContent = gameState.player1.tacticalVp;
            document.getElementById('p1_totalVp').textContent = gameState.player1.totalVp;

            document.getElementById('p2_name').textContent = gameState.player2.name;
            document.getElementById('p2_cp').textContent = gameState.player2.cp;
            document.getElementById('p2_challengerVp').textContent = gameState.player2.challengerVp;
            document.getElementById('p2_tacticalVp').textContent = gameState.player2.tacticalVp;
            document.getElementById('p2_totalVp').textContent = gameState.player2.totalVp;

            renderPrimaryMission(1);
            renderPrimaryMission(2);
            renderPlayerSecondaries(1);
            renderPlayerSecondaries(2);
        }

        function populateSetupDropdowns(objectives, primaries) {
            const selects = document.querySelectorAll('#setupPage .secondary-select');
            selects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = "Select Secondary...";
                defaultOption.textContent = "Select Secondary...";
                select.appendChild(defaultOption);
                objectives.forEach(obj => {
                    const option = document.createElement('option');
                    option.value = obj.name;
                    option.textContent = obj.name;
                    select.appendChild(option);
                });
                select.value = currentVal;
            });

            const primarySelect = document.getElementById('setup_primary_mission');
            const currentPrimary = primarySelect.value;
            primarySelect.innerHTML = '';
            const defaultPrimary = document.createElement('option');
            defaultPrimary.value = "Select Primary Mission...";
            defaultPrimary.textContent = "Select Primary Mission...";
            primarySelect.appendChild(defaultPrimary);
            primaries.forEach(p => {
                const option = document.createElement('option');
                option.value = p.name;
                option.textContent = p.name;
                primarySelect.appendChild(option);
            });
            primarySelect.value = currentPrimary;
        }

        function renderPrimaryMission(playerNum) {
            const area = document.getElementById(`p${playerNum}_primary_area`);
            const mission = primaryMissions.find(p => p.name === gameState.primaryMission);
            area.innerHTML = '';
            if (!mission) return;

            const tiersHTML = mission.scoring_tiers.map(tier => 
                `<button class="tier-btn" data-player="${playerNum}" data-primary-vp="${tier.vp}">${tier.label} (+${tier.vp} VP)</button>`
            ).join('');

            area.innerHTML = `
                <h3 class="text-lg font-bold mb-2">${mission.name}</h3>
                <div class="space-y-2">${tiersHTML}</div>
                <div class="flex justify-between items-center mt-3">
                    <span class="text-xl font-semibold">Score: <span id="p${playerNum}_primaryVp" class="font-bold">${gameState[`player${playerNum}`].primaryVp}</span></span>
                </div>
            `;
        }

        function renderPlayerSecondaries(playerNum) {
            const player = gameState[`player${playerNum}`];
            const area = document.getElementById(`p${playerNum}_secondaries_area`);
            area.innerHTML = '';

            if (player.missionType === 'Fixed') {
                for (let i = 1; i <= 2; i++) {
                    const secondaryKey = `secondary${i}`;
                    const secondary = player[secondaryKey] || { name: 'Not Selected', score: 0 };
                    const secondaryData = fixedObjectives.find(s => s.name === secondary.name);
                    
                    const container = document.createElement('div');
                    container.className = 'bg-gray-900 p-3 rounded-lg';
                    let tiersHTML = '';
                    if (secondaryData && secondaryData.scoring_tiers) {
                        tiersHTML = secondaryData.scoring_tiers.map(tier => 
                            `<button class="tier-btn" data-player="${playerNum}" data-secondary="${i}" data-fixed-vp="${tier.vp}">${tier.label} (+${tier.vp} VP)</button>`
                        ).join('');
                    }

                    container.innerHTML = `
                        <h3 class="text-lg font-bold mb-2">${secondary.name}</h3>
                        <div class="space-y-2">${tiersHTML}</div>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xl font-semibold">Score: <span id="p${playerNum}_sec${i}_score" class="font-bold">${secondary.score}</span></span>
                            <button data-player="${playerNum}" data-secondary="${i}" class="bg-amber-600 hover:bg-amber-500 text-white text-sm font-bold py-1 px-3 rounded op-clear-btn">Clear</button>
                        </div>
                    `;
                    area.appendChild(container);
                }
            } else {
                const container = document.createElement('div');
                container.className = 'bg-gray-900 p-3 rounded-lg';
                
                let missionsHTML = '';
                for (let i = 1; i <= 2; i++) {
                    const activeTacticalKey = `activeTactical${i}`;
                    let missionHTML = '';
                    if (player[activeTacticalKey]) {
                        const mission = tacticalObjectives.find(t => t.name === player[activeTacticalKey]);
                        if (mission) {
                            missionHTML = `
                                <h4 class="text-lg font-bold">${mission.name}</h4>
                                <p class="text-sm text-gray-400">${mission.description}</p>
                                <div class="space-y-2 mt-2">
                                    ${mission.scoring_tiers.map(tier => `<button class="tier-btn" data-player="${playerNum}" data-tactical-slot="${i}" data-tactical-vp="${tier.vp}">+${tier.vp} VP: ${tier.label}</button>`).join('')}
                                </div>
                                <button data-player="${playerNum}" data-tactical-slot="${i}" class="w-full mt-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-1 px-3 rounded complete-tactical-btn">Complete Mission</button>
                            `;
                        }
                    } else {
                        missionHTML = `<p class="text-center text-gray-400">Slot ${i} Empty</p>`;
                    }
                    missionsHTML += `<div class="bg-gray-800 p-3 rounded-md min-h-[100px] mb-3">${missionHTML}</div>`;
                }

                container.innerHTML = `
                    <h3 class="text-xl font-bold text-center mb-2">Secondaries</h3>
                    ${missionsHTML}
                    <button data-player="${playerNum}" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded draw-tactical-btn">Draw Secondary</button>
                `;
                area.appendChild(container);
            }
        }
        
        async function handleStartGame() {
            const p1_name = document.getElementById('setup_p1_name').value || "Player 1";
            const p1_faction = document.getElementById('setup_p1_faction').value;
            const p1_detachment = document.getElementById('setup_p1_detachment').value;
            const p1_role = document.querySelector('#setup_p1_role .toggle-btn-active').dataset.role;
            const p1_missions = document.querySelector('#setup_p1_missions .toggle-btn-active').dataset.mission;

            const p2_name = document.getElementById('setup_p2_name').value || "Player 2";
            const p2_faction = document.getElementById('setup_p2_faction').value;
            const p2_detachment = document.getElementById('setup_p2_detachment').value;
            const p2_role = document.querySelector('#setup_p2_role .toggle-btn-active').dataset.role;
            const p2_missions = document.querySelector('#setup_p2_missions .toggle-btn-active').dataset.mission;
            
            const primaryMission = document.getElementById('setup_primary_mission').value;

            const payload = {
                'gameState.primaryMission': primaryMission,
                'gameState.player1.name': p1_name, 'gameState.player1.faction': p1_faction, 'gameState.player1.detachment': p1_detachment, 'gameState.player1.role': p1_role, 'gameState.player1.missionType': p1_missions,
                'gameState.player2.name': p2_name, 'gameState.player2.faction': p2_faction, 'gameState.player2.detachment': p2_detachment, 'gameState.player2.role': p2_role, 'gameState.player2.missionType': p2_missions,
                'gameState.setupComplete': true
            };

            if (p1_missions === 'Fixed') {
                const p1_sec1 = document.getElementById('setup_p1_sec1').value;
                const p1_sec2 = document.getElementById('setup_p1_sec2').value;
                if (p1_sec1 !== "Select Secondary...") payload['gameState.player1.secondary1.name'] = p1_sec1;
                if (p1_sec2 !== "Select Secondary...") payload['gameState.player1.secondary2.name'] = p1_sec2;
            }
             if (p2_missions === 'Fixed') {
                const p2_sec1 = document.getElementById('setup_p2_sec1').value;
                const p2_sec2 = document.getElementById('setup_p2_sec2').value;
                if (p2_sec1 !== "Select Secondary...") payload['gameState.player2.secondary1.name'] = p2_sec1;
                if (p2_sec2 !== "Select Secondary...") payload['gameState.player2.secondary2.name'] = p2_sec2;
            }

            await updateDoc(appDocRef, payload);
        }

        async function handleBackToSetup() {
            await updateDoc(appDocRef, { 'gameState.setupComplete': false });
        }

        function toggleFixedMissionView(playerNum, missionType) {
            const fixedMissionsDiv = document.getElementById(`setup_p${playerNum}_fixed_missions`);
            if (missionType === 'Fixed') {
                fixedMissionsDiv.classList.remove('hidden');
            } else {
                fixedMissionsDiv.classList.add('hidden');
            }
        }

        function renderScoreSheet() {
            const content = document.getElementById('scoreSheetContent');
            content.innerHTML = `<p class="text-center">Score sheet coming soon!</p>`;
        }

        function calculateTotals() {
            const p1 = gameState.player1;
            const p2 = gameState.player2;
            p1.totalVp = (p1.primaryVp || 0) + (p1.challengerVp || 0) + (p1.tacticalVp || 0) + (p1.secondary1?.score || 0) + (p1.secondary2?.score || 0);
            p2.totalVp = (p2.primaryVp || 0) + (p2.challengerVp || 0) + (p2.tacticalVp || 0) + (p2.secondary1?.score || 0) + (p2.secondary2?.score || 0);
        }

        async function updateFirestore(payload) {
            calculateTotals();
            const fullPayload = { ...payload };
            fullPayload['gameState.player1.totalVp'] = gameState.player1.totalVp;
            fullPayload['gameState.player2.totalVp'] = gameState.player2.totalVp;
            await updateDoc(appDocRef, fullPayload);
        }
        
        async function handleScoreboardClick(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const playerNum = target.dataset.player;
            if (!playerNum) return;

            const player = gameState[`player${playerNum}`];

            if (target.classList.contains('op-btn')) {
                const field = target.dataset.field;
                const isIncrement = target.classList.contains('btn-green');
                const key = `gameState.player${playerNum}.${field}`;
                const currentValue = player[field] || 0;
                const newValue = isIncrement ? currentValue + 1 : Math.max(0, currentValue - 1);
                gameState[`player${playerNum}`][field] = newValue; 
                await updateFirestore({ [key]: newValue });

            } else if (target.classList.contains('tier-btn')) {
                const fixedVp = target.dataset.fixedVp;
                const tacticalVp = target.dataset.tacticalVp;
                const primaryVp = target.dataset.primaryVp;

                if (fixedVp) {
                    const secondary = target.dataset.secondary;
                    const vp = parseInt(fixedVp, 10);
                    const key = `gameState.player${playerNum}.secondary${secondary}.score`;
                    const currentScore = player[`secondary${secondary}`].score || 0;
                    gameState[`player${playerNum}`][`secondary${secondary}`].score = currentScore + vp; 
                    await updateFirestore({ [key]: currentScore + vp });
                } else if (tacticalVp) {
                    const slot = target.dataset.tacticalSlot;
                    const vp = parseInt(tacticalVp, 10);
                    const key = `gameState.player${playerNum}.tacticalVp`;
                    const currentValue = player.tacticalVp || 0;
                    gameState[`player${playerNum}`].tacticalVp = currentValue + vp;
                    await updateFirestore({ [key]: currentValue + vp });
                } else if (primaryVp) {
                    const vp = parseInt(primaryVp, 10);
                    const key = `gameState.player${playerNum}.primaryVp`;
                    const currentValue = player.primaryVp || 0;
                    gameState[`player${playerNum}`].primaryVp = currentValue + vp;
                    await updateFirestore({ [key]: currentValue + vp });
                }
            } else if (target.classList.contains('draw-tactical-btn')) {
                const drawnIds = player.drawnTacticalIds || [];
                const available = tacticalObjectives.filter(t => !drawnIds.includes(t.name));
                if (available.length > 0) {
                    const mission = available[Math.floor(Math.random() * available.length)];
                    const newDrawnIds = [...drawnIds, mission.name];
                    let payload = { [`gameState.player${playerNum}.drawnTacticalIds`]: newDrawnIds };
                    if (!player.activeTactical1) {
                        payload[`gameState.player${playerNum}.activeTactical1`] = mission.name;
                    } else if (!player.activeTactical2) {
                        payload[`gameState.player${playerNum}.activeTactical2`] = mission.name;
                    } else {
                        alert("Both tactical slots are full!");
                        return;
                    }
                    await updateFirestore(payload);
                } else {
                    alert("No more Tactical Missions to draw!");
                }
            } else if (target.classList.contains('complete-tactical-btn')) {
                 const slot = target.dataset.tacticalSlot;
                 await updateFirestore({ [`gameState.player${playerNum}.activeTactical${slot}`]: null });
            } else if (target.classList.contains('op-clear-btn')) {
                const secondary = target.dataset.secondary;
                const key = `gameState.player${playerNum}.secondary${secondary}.score`;
                gameState[`player${playerNum}`][`secondary${secondary}`].score = 0;
                await updateFirestore({ [key]: 0 });
            }
        }
        
        async function handleTurnChange(increment) {
            const currentTurn = gameState.turn || 1;
            let newTurn = increment ? Math.min(5, currentTurn + 1) : Math.max(1, currentTurn - 1);
            await updateFirestore({ 'gameState.turn': newTurn });
        }
        
        async function resetGame() {
            if (confirm("Are you sure you want to completely reset the game? This will erase all setup info and scores.")) {
                const currentData = await getDoc(appDocRef);
                const newData = getInitialData();
                newData.fixed_objectives = currentData.data().fixed_objectives;
                newData.tactical_objectives = currentData.data().tactical_objectives;
                newData.primary_missions = currentData.data().primary_missions;
                await setDoc(appDocRef, newData);
            }
        }

        function getInitialData() {
             return {
                gameState: {
                    setupComplete: false, turn: 1, primaryMission: "Select Primary Mission...",
                    player1: { name: "Player 1", faction: "", detachment: "", role: "Attacker", missionType: "Fixed", cp: 0, primaryVp: 0, challengerVp: 0, tacticalVp: 0, totalVp: 0, drawnTacticalIds: [], activeTactical1: null, activeTactical2: null, secondary1: {name: "Select Secondary...", score: 0}, secondary2: {name: "Select Secondary...", score: 0} },
                    player2: { name: "Player 2", faction: "", detachment: "", role: "Defender", missionType: "Fixed", cp: 0, primaryVp: 0, challengerVp: 0, totalVp: 0, drawnTacticalIds: [], activeTactical1: null, activeTactical2: null, secondary1: {name: "Select Secondary...", score: 0}, secondary2: {name: "Select Secondary...", score: 0} }
                },
                fixed_objectives: [],
                tactical_objectives: [],
                primary_missions: []
            };
        }

        async function init() {
            try {
                await signInAnonymously(auth);
                const docId = "warhammer-game-data";
                appDocRef = doc(db, "gamedata", docId);

                const appDocSnap = await getDoc(appDocRef);
                if (!appDocSnap.exists()) {
                    await setDoc(appDocRef, getInitialData());
                }

                onSnapshot(appDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        updateUI(docSnap.data());
                    }
                });

                startGameBtn.addEventListener('click', handleStartGame);
                backToSetupBtn.addEventListener('click', handleBackToSetup);
                resetGameBtn.addEventListener('click', resetGame);
                fullScoreSheetBtn.addEventListener('click', () => {
                    renderScoreSheet();
                    scoreSheetModal.classList.remove('hidden');
                });
                closeScoreSheetBtn.addEventListener('click', () => scoreSheetModal.classList.add('hidden'));
                printScoreSheetBtn.addEventListener('click', () => window.print());
                
                document.getElementById('nextTurnBtn').addEventListener('click', () => handleTurnChange(true));
                document.getElementById('prevTurnBtn').addEventListener('click', () => handleTurnChange(false));

                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (btn.classList.contains('toggle-btn-active')) return;
                        const parent = btn.parentElement;
                        parent.querySelectorAll('.toggle-btn').forEach(b => b.classList.replace('toggle-btn-active', 'toggle-btn-inactive'));
                        btn.classList.replace('toggle-btn-inactive', 'toggle-btn-active');

                        if (parent.id.includes('role')) {
                           const otherPlayer = btn.dataset.player === '1' ? '2' : '1';
                           const otherRole = btn.dataset.role === 'Attacker' ? 'Defender' : 'Attacker';
                           const otherParent = document.getElementById(`setup_p${otherPlayer}_role`);
                           otherParent.querySelectorAll('.toggle-btn').forEach(b => {
                               if (b.dataset.role === otherRole) b.classList.replace('toggle-btn-inactive', 'toggle-btn-active');
                               else b.classList.replace('toggle-btn-active', 'toggle-btn-inactive');
                           });
                        }
                        
                        if (parent.id.includes('missions')) {
                            toggleFixedMissionView(btn.dataset.player, btn.dataset.mission);
                        }
                    });
                });

                scoreboardPage.addEventListener('click', handleScoreboardClick);

            } catch (error) {
                console.error("A critical error occurred during initialization:", error);
            }
        }

        init();
    </script>
</body>
</html>
